{
  "builders": [
    {
      "type": "googlecompute",
      "project_id": "anthony-dimaria",
      "source_image": "rhel-7-v20180911",
      "ssh_username": "adimaria",
      "zone": "us-east1-b",
      "account_file": "account_file.json"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sudo yum install gcc python-devel python-setuptools redhat-rpm-config -y",
        "sudo easy_install -U pip",
        "sudo pip uninstall crcmod",
        "sudo pip install -U crcmod",
        "gsutil cp gs://fr-bits/* .",
        "sudo yum install java-1.8.0-openjdk-devel -y",
        "export JAVA_HOME=/usr/lib/jvm/java-openjdk",
        "export PATH=$PATH:$JAVA_HOME/bin",
        "echo /etc/security/limits.conf opendj soft nofile 65536 opendj hard nofile 131072"
        "sysctl fs.inotify.max_user_watches",
        "sudo sysctl --write fs.inotify.max_user_watches=524288",
        "sudo rpm -i DS*.rpm",
        "cd /opt/opendj",
        "cat Password1 > pwd.txt"
        "./setup directory-server \\
          --rootUserDN \"cn=Directory Manager\" \\
          --rootUserPasswordFile pwd.txt \\
          --hostname localhost \\
          --ldapPort 1389 \\
          --ldapsPort 1636 \\
          --httpsPort 8443 \\
          --adminConnectorPort 4444 \\
          --baseDN dc=example,dc=com \\
          --addBaseEntry \\
          --acceptLicense",
        "cd bin",
        "dsconfig create-backend \\
          --backend-name cfgStore \\
          --set base-dn:dc=example,dc=com \\
          --set enabled:true \\
          --type je \\
          --port 4444 \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          --no-prompt",
        "bin/ldapmodify \\
          --port 1389 \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          ~/add-config-entries.ldif",
        "bin/dsconfig set-access-control-handler-prop \\
          --add global-aci:'(target = \"ldap:///cn=schema\")(targetattr = \"attributeTypes || objectClasses\")(version 3.0; acl \"Modify schema\"; allow (write)(userdn = \"ldap:///uid=openam,ou=admins,dc=example,dc=com\");)' \\
          --port 4444 \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          --no-prompt",
        "bin/ldapmodify \\
          --port 1389 \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          ~/cts-add-schema.ldif",
        "bin/ldapmodify \\
          --port 1389 \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          ~/opendj_user_schema.ldif",
        "bin/ldapmodify \\
          --port 1389 \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          ~/opendj_config_schema.ldif",
        "dsconfig create-backend-index \\
          --port 4444 \\
          --hostname localhost \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          --backend-name cfgStore \\
          --index-name sunxmlkeyvalue \\
          --set index-type:equality \\
          --set index-type:substring \\
          --no-prompt",
        "dsconfig create-backend-index \\
          --port 4444 \\
          --hostname localhost \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          --backend-name cfgStore \\
          --index-name iplanet-am-user-federation-info-key \\
          --set index-type:equality \\
          --no-prompt",
        "dsconfig create-backend-index \\
          --port 4444 \\
          --hostname localhost \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          --backend-name cfgStore \\
          --index-name sun-fm-saml2-nameid-infokey \\
          --set index-type:equality \\
          --no-prompt"
        "bin/rebuild-index \\
          --port 4444 \\
          --hostname localhost \\
          --bindDN \"cn=Directory Manager\" \\
          --bindPassword Password1 \\
          --baseDN dc=example,dc=com --rebuildAll \\
          --start 0"
      ]
    }
  ]
}